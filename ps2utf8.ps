%%C- -------------------------------------------------------------------
%%C- ps2utf8 - copyright (c) 2002-2005 Leon Bottou.
%%C-
%%C- This software may be distributed under
%%C- the terms of the GNU General Public License. The license should have
%%C- accompanied the software or you may obtain a copy of the license
%%C- from the Free Software Foundation at http://www.fsf.org .
%%C-
%%C- This software may also be distributed under
%%C- the terms of the Common Public License 1.0. The license should have
%%C- accompanied the software or you may obtain a copy of the license
%%C- from the Free Software Foundation at http://www.fsf.org .
%%C-
%%C- This program is distributed in the hope that it will be useful,
%%C- but WITHOUT ANY WARRANTY; without even the implied warranty of
%%C- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%%C- GNU General Public License for more details.
%%C- -------------------------------------------------------------------

%%%% Most of this has been made obsolete by the gdevdjvu -dExtractText
%%%% parameter. The main role of this file is to install a proper
%%%% encoding vector for LaTeX fonts.

% Check that system directory is writable
systemdict wcheck not { 
  (ps2utf8: must use option -dWRITESYSTEMDICT\n) print quit 
} if

systemdict begin

%%% ------------------------------------------------------------------------
%%% Make sure ExtractText works.

/ExtractText true def
currentdevice .devicename /djvusep eq {
  << /ExtractText true >> setpagedevice
} {
  (ps2utf8: has been made obsolete by -dExtractText in gdevdjvu.\n) print
  (ps2utf8: this is only a placeholder.\n) print
  quit 
} ifelse


%%% ------------------------------------------------------------------------
%%% Set global memory

currentglobal /setglobal load true setglobal


%%% ------------------------------------------------------------------------
%%% Make sure ProvideUnicode works.

/ProvideUnicode true def
systemdict /.setupUnicodeDecoder known {
  /Unicode /Decoding resourcestatus {
     pop pop /Unicode /Decoding findresource
     .setupUnicodeDecoder
  } if
} if



%%% ------------------------------------------------------------------------
%%% Define dictionary for ps2utf8 code
/.ps2utf8 17 dict def
.ps2utf8 begin


%%% ------------------------------------------------------------------------
%%% TeX/LaTeX hacks ( derived from ps2ascii.ps )

/T1Encoding [
  /grave /acute /circumflex /tilde /dieresis /hungarumlaut /ring /caron
  /breve /macron /dotaccent /cedilla /ogonek /quotesinglbase
  /guilsinglleft /guilsinglright /quotedblleft /quotedblright
  /quotedblbase /guillemotleft /guillemotright /endash /emdash /cwm
  /perthousandzero /dotlessi /dotlessj /ff /fi /fl /ffi /ffl /space
  /exclam /quotedbl /numbersign /dollar /percent /ampersand /quoteright
  /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
  /zero /one /two /three /four /five /six /seven /eight /nine /colon
  /semicolon /less /equal /greater /question /at /A /B /C /D /E /F /G /H
  /I /J /K /L /M /N /O /P /Q /R /S /T /U /V /W /X /Y /Z /bracketleft
  /backslash /bracketright /asciicircum /underscore /quoteleft /a /b /c /d
  /e /f /g /h /i /j /k /l /m /n /o /p /q /r /s /t /u /v /w /x /y /z
  /braceleft /bar /braceright /asciitilde /hyphen /Abreve /Aogonek /Cacute
  /Ccaron /Dcaron /Ecaron /Eogonek /Gbreve /Lacute /Lcaron /Lslash /Nacute
  /Ncaron /Eng /Ohungarumlaut /Racute /Rcaron /Sacute /Scaron /Scedilla
  /Tcaron /Tcedilla /Uhungarumlaut /Uring /Ydieresis /Zacute /Zcaron /Zdot
  /IJ /Idot /dbar /section /abreve /aogonek /cacute /ccaron /dcaron
  /ecaron /eogonek /gbreve /lacute /lcaron /lslash /nacute /ncaron /eng
  /ohungarumlaut /racute /rcaron /sacute /scaron /scedilla /tcaron
  /tcedilla /uhungarumlaut /uring /ydieresis /zacute /zcaron /zdot /ij
  /exclamdown /questiondown /sterling /Agrave /Aacute /Acircumflex /Atilde
  /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute /Ecircumflex /Edieresis
  /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde /Ograve /Oacute
  /Ocircumflex /Otilde /Odieresis /OE /Oslash /Ugrave /Uacute /Ucircumflex
  /Udieresis /Yacute /Thorn /Germandbls /agrave /aacute /acircumflex
  /atilde /adieresis /aring /ae /ccedilla /egrave /eacute /ecircumflex
  /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde /ograve
  /oacute /ocircumflex /otilde /odieresis /oe /oslash /ugrave /uacute
  /ucircumflex /udieresis /yacute /thorn /germandbls
] def

/OT1Encoding [
  /Gamma /Delta /Theta /Lambda /Xi /Pi /Sigma /Upsilon /Phi /Psi /Omega
  /ff /fi /fl /ffi /ffl /dotlessi /dotlessj /grave /acute /caron /breve
  /macron /ring /cedilla /germandbls /ae /oe /oslash /AE /OE /Oslash
  /polishslash /exclam /quotedblright /numbersign /dollar /percent
  /ampersand /quoteright /parenleft /parenright /asterisk /plus /comma
  /hyphen /period /slash /zero /one /two /three /four /five /six /seven
  /eight /nine /colon /semicolon /exclamdown /equal /questiondown
  /question /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O /P /Q /R /S
  /T /U /V /W /X /Y /Z /bracketleft /quotedblleft /bracketright
  /asciicircum /dotaccent /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l
  /m /n /o /p /q /r /s /t /u /v /w /x /y /z /endash /emdash /hungarumlaut
  /asciitilde /dieresis /Abreve /Aogonek /Cacute /Ccaron /Dcaron /Ecaron
  /Eogonek /Gbreve /Lacute /Lcaron /Lslash /Nacute /Ncaron /Eng
  /Ohungarumlaut /Racute /Rcaron /Sacute /Scaron /Scedilla /Tcaron
  /Tcedilla /Uhungarumlaut /Uring /Ydieresis /Zacute /Zcaron /Zdot /IJ
  /Idot /dbar /section /abreve /aogonek /cacute /ccaron /dcaron /ecaron
  /eogonek /gbreve /lacute /lcaron /lslash /nacute /ncaron /eng
  /ohungarumlaut /racute /rcaron /sacute /scaron /scedilla /tcaron
  /tcedilla /uhungarumlaut /uring /ydieresis /zacute /zcaron /zdot /ij
  /exclamdown /questiondown /sterling /Agrave /Aacute /Acircumflex /Atilde
  /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute /Ecircumflex /Edieresis
  /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde /Ograve /Oacute
  /Ocircumflex /Otilde /Odieresis /OE /Oslash /Ugrave /Uacute /Ucircumflex
  /Udieresis /Yacute /Thorn /Germandbls /agrave /aacute /acircumflex
  /atilde /adieresis /aring /ae /ccedilla /egrave /eacute /ecircumflex
  /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde /ograve
  /oacute /ocircumflex /otilde /odieresis /oe /oslash /ugrave /uacute
  /ucircumflex /udieresis /yacute /thorn /germandbls
] def

% Hack DVIPS to place proper encoding vector into fonts
/df-tail {
    /nn 9 dict N nn begin
        %%  Choose an encoding based on the highest position occupied.
        dup 128 gt { /T1Encoding } { /OT1Encoding } ifelse 
        .ps2utf8 exch get /Encoding X
        %%  Go on
        /FontType 3 N
	/FontMatrix fntrx N
        string /base X
        array /BitMaps X
        /BuildChar {CharBuilder} N
    end
    dup { /foo setfont } 2 array copy cvx N
    load 0 nn put /ctr 0 N [
} def

% Define start-hook to replace df-tail and D by our versions.
% Unfortunately, the user can redefine start-hook and thus bypass
% these changes, but I don't see an obvious way around that.
userdict /start-hook {
  TeXDict begin /df-tail .ps2utf8 /df-tail get bind def end
} put 


%%% ------------------------------------------------------------------------
%%% Finalization

% Finish directories
end % ps2utf8
end % systemdict

% Perform delayed binds
NOBIND { 
  systemdict begin .bindoperators end 
}{ 
  .bindnow 
} ifelse

% Binding is then back to normal
systemdict begin
      /NOBIND false def
      /DELAYBIND false def 
      /bind /.bind load def 
end

% Make systemdict readonly
systemdict readonly pop

% Restore allocation mode
exec

